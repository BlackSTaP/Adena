<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä L2</title>
  <link rel="icon" href="https://github.com/BlackSTaP/Adena/blob/main/adena.png?raw=true" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f7f9fc; --bg-dark: #1c1c1c; --panel-light: #ffffff; --panel-dark: #262626;
      --text-light: #333333; --text-dark: #e1e1e1; --accent: #3a8dde; --accent-hover: #3274c8;
      --error: #e74c3c; --success: #2ecc71; --radius: 8px; --spacing: 16px; --transition: 0.3s;
      --font-base: 16px; --line-h: 1.6; --toggle-size: 46px;
      --text-secondary-light: #aaa; --text-secondary-dark: #777;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: var(--font-base); line-height: var(--line-h); color: var(--text-light);
      background: var(--bg-light); transition: background var(--transition), color var(--transition);
      display: flex; flex-direction: column; align-items: center;
    }
    body.dark { background: var(--bg-dark); color: var(--text-dark); }
    .header-controls {
        position: fixed; top: var(--spacing); left: 50%; transform: translateX(-50%);
        display: flex; gap: var(--spacing); align-items: center; z-index: 1000;
    }
    .control-button {
      width: var(--toggle-size); height: var(--toggle-size); border-radius: 50%; padding: 0;
      background: var(--panel-light); color: var(--accent); border: 2px solid var(--accent);
      display: flex; justify-content: center; align-items: center; cursor: pointer;
      transition: background var(--transition), color var(--transition), border-color var(--transition);
      font-size: 1.2rem;
    }
    .control-button svg { width: 50%; height: 50%; fill: var(--accent); transition: fill var(--transition); }
    body.dark .control-button {
      background: var(--panel-dark); color: var(--accent-hover); border-color: var(--accent-hover);
    }
    body.dark .control-button svg { fill: var(--accent-hover); }
    .container {
      display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing); max-width: 960px;
      width: 100%; margin: 120px auto 0; padding: 0 var(--spacing);
    }
    .panel, .history {
      background: var(--panel-light); padding: var(--spacing); border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: background var(--transition);
    }
    body.dark .panel, body.dark .history { background: var(--panel-dark); }
    h1, h2 { margin-top: 0; } h1 { font-size: 1.5rem; margin-bottom: var(--spacing); }
    .field { margin-bottom: var(--spacing); }
    label { display: block; margin-bottom: 4px; font-weight: 500; }
    input {
      width: 100%; padding: 8px 12px; font-size: 1rem; border: 1px solid #ccc;
      border-radius: var(--radius); transition: border var(--transition), box-shadow var(--transition);
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(58,141,222,0.3); outline: none; }
    input:disabled, button:disabled { opacity: 0.6; cursor: not-allowed; }
    .buttons { display: flex; gap: var(--spacing); flex-wrap: wrap; margin-bottom: var(--spacing); }
    button {
      flex: 1; padding: 10px; font-size: 1rem; border: none; border-radius: var(--radius);
      cursor: pointer; transition: background var(--transition), opacity var(--transition);
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .result-wrapper { display: flex; justify-content: center; align-items: center; gap: 12px; min-height: 1.5em; margin-top: var(--spacing); }
    #result { font-size: 1.25rem; font-weight: 600; }
    #copy-btn { flex: none; padding: 0; width: 32px; height: 32px; background: none; border: none; color: var(--text-light); opacity: 0.6; transition: opacity 0.2s, color 0.2s; cursor: pointer;}
    body.dark #copy-btn { color: var(--text-dark); }
    #copy-btn:hover { opacity: 1; }
    .history { max-height: 70vh; overflow-y: auto; }
    .entry { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing) 8px; margin-bottom: var(--spacing); background: rgba(0,0,0,0.03); border-radius: var(--radius); transition: background var(--transition); }
    body.dark .entry { background: rgba(255,255,255,0.05); }
    .entry-info { display: flex; flex-direction: column; flex-grow: 1; }
    .entry-info span { display: inline-flex; align-items: center; gap: 4px; }
    .entry-info span:first-child { font-weight: 600; }
    .entry-info span:last-child { font-size: 0.875rem; color: #666; transition: color var(--transition); }
    body.dark .entry-info span:last-child { color: #aaa; }
    .entry-buttons { display: flex; align-items: center; gap: 4px; }
    .entry-btn { flex: none; width: 30px; height: 30px; padding: 0; background: none; border: none; opacity: 0.5; transition: opacity 0.2s; cursor: pointer; }
    .entry-btn:hover { opacity: 1; }
    .entry-btn svg { width: 16px; height: 16px; fill: var(--text-light); }
    body.dark .entry-btn svg { fill: var(--text-dark); }
    .del-btn { color: var(--error); font-size: 1.5rem; line-height: 1; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .overlay.active { display: flex; }
    .modal { background: var(--panel-light); padding: var(--spacing); border-radius: var(--radius); max-width: 600px; width: 90%; box-shadow: 0 2px 12px rgba(0,0,0,0.2); position: relative; }
    body.dark .modal { background: var(--panel-dark); }
    .modal-close { position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 1.25rem; color: var(--error); cursor: pointer; }
    #profile-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: var(--spacing); max-height: 200px; overflow-y: auto; }
    .profile-entry { display: flex; align-items: center; gap: 8px; }
    .profile-name-btn { flex-grow: 1; text-align: center; padding: 5px 10px; font-size: 0.9rem; line-height: 1.4; }
    .profile-delete-btn { background: none; border: none; padding: 4px 8px; border-radius: var(--radius); color: var(--text-secondary-light); font-size: 1.25rem; font-weight: normal; cursor: pointer; transition: color 0.2s, background-color 0.2s; }
    body.dark .profile-delete-btn { color: var(--text-secondary-dark); }
    .profile-delete-btn:hover { color: var(--error); background-color: rgba(231, 76, 60, 0.1); }
    #profile-status { font-size: 0.9rem; text-align: center; font-weight: 600; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background-color: var(--success); color: #fff; padding: 12px 20px; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .site-footer { width: 100%; text-align: center; padding: var(--spacing) 0; margin-top: 40px; color: var(--text-secondary-light); }
    body.dark .site-footer { color: var(--text-secondary-dark); }
    .site-footer p { margin: 0; font-family: 'Caveat', cursive; font-size: 1.3rem; font-weight: 700; }
    @media (max-width: 800px) { .container { display: block; margin-top: 140px; } .history { margin-top: var(--spacing); } }
  </style>
</head>
<body>
  <div class="header-controls">
    <button id="profile-btn" class="control-button" onclick="app.openProfileManager()" title="–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
    </button>
    <button id="toggle-theme" class="control-button" onclick="app.toggleTheme()" title="–¢–µ–º–∞">üåô</button>
  </div>
  <div class="container">
    <div class="panel">
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–∞—Ä–º–∞ –∞–¥–µ–Ω</h1>
      <div id="profile-status">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.</div>
      <div class="field">
        <label for="location">–õ–æ–∫–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="location" type="text" placeholder="–õ–æ–∫–∞—Ü–∏—è" disabled/>
      </div>
      <div class="field">
        <label for="adena">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–µ–Ω</label>
        <input id="adena" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–µ–Ω" disabled/>
      </div>
      <div class="field">
        <label for="minutes">–í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö</label>
        <input id="minutes" type="number" placeholder="–í—Ä–µ–º—è (–º–∏–Ω)" disabled/>
      </div>
      <div class="buttons">
        <button id="save-btn" class="btn-primary" onclick="app.saveResult()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="stats-btn" class="btn-primary" onclick="app.openStats()" disabled>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </div>
      <div class="result-wrapper">
        <div id="result" aria-live="polite"></div>
        <button id="copy-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ" style="display: none;" onclick="app.copyResult()">
          <svg fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
        </button>
      </div>
    </div>
    <div class="history">
      <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
      <div id="history-list"><p><em>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</em></p></div>
    </div>
  </div>
  <div class="overlay" id="statsOverlay">
    <div class="modal"> <button class="modal-close" onclick="app.closeStats()">‚úï</button> <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞—Ä–º–∞</h3> <canvas id="statsChart"></canvas> </div>
  </div>
  <div class="overlay" id="profileOverlay">
    <div class="modal">
      <button class="modal-close" onclick="app.closeProfileManager()">‚úï</button>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h3>
      <div id="profile-list-container"> <p>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏:</p> <div id="profile-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div> </div>
      <hr>
      <p>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π:</p>
      <div class="field"> <input id="new-profile-name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è"/> </div>
      <button class="btn-primary" onclick="app.createNewProfile()">–°–æ–∑–¥–∞—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å</button>
    </div>
  </div>
  <div id="toast-container"></div>
  <footer class="site-footer">
    <p>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∞–¥–µ–Ω by EvilBlack</p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, getDocs, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyDb3e-6m-ryG4rhK7-w8vptqj4SMUS2Hhw',
      authDomain: 'adenafarm-3260d.firebaseapp.com',
      projectId: 'adenafarm-3260d',
      storageBucket: 'adenafarm-3260d.appspot.com',
      messagingSenderId: '455723070548',
      appId: '1:455723070548:web:03eb62738536d4a0ada9c1'
    };
    
    const appModule = () => {
      initializeApp(firebaseConfig);
      const db = getFirestore();
      const $ = id => document.getElementById(id);

      let currentProfile = null;
      let historyUnsubscribe = null;
      let currentPerHourResult = null;

      const showToast = (message) => {
        const container = $('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
      };

      const formatAdenaShort = (num) => {
        if (num >= 1000000000) return `${parseFloat((num / 1000000000).toFixed(2))}–∫–∫–∫`;
        if (num >= 1000000) return `${parseFloat((num / 1000000).toFixed(2))}–∫–∫`;
        if (num >= 10000) return `${parseFloat((num / 1000).toFixed(1))}–∫`;
        return num.toLocaleString('ru-RU');
      };

      const fallbackCopyToClipboard = (text) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        } catch (err) {
          showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.');
        }
        document.body.removeChild(textArea);
      };

      const copyText = async (text) => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
          } catch (err) {
            fallbackCopyToClipboard(text);
          }
        } else {
          fallbackCopyToClipboard(text);
        }
      };
      
      const copyResult = () => {
        if (currentPerHourResult === null) return;
        copyText(currentPerHourResult.toString());
      };

      const copyHistoryEntry = (textToCopy) => {
         copyText(textToCopy);
      };

      const calculate = () => {
        const a = parseFloat($('adena').value);
        const m = parseFloat($('minutes').value);
        const copyBtn = $('copy-btn');
        if (!a || !m) {
          currentPerHourResult = null;
          if (copyBtn) copyBtn.style.display = 'none';
          $('result').textContent = '';
          return null;
        }
        const perHour = (a / m) * 60;
        currentPerHourResult = Math.round(perHour);
        $('result').textContent = `–ó–∞ —á–∞—Å: ${perHour.toLocaleString('ru-RU')} –∞–¥–µ–Ω`;
        if (copyBtn) copyBtn.style.display = 'inline-block';
        return currentPerHourResult;
      };

      const saveResult = async () => {
        if (!currentProfile) { showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å'); return; }
        const perHour = calculate();
        if (!perHour) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.'); return; }
        try {
          await addDoc(collection(db, 'profiles', currentProfile, 'logs'), {
            location: ($('location').value || '–ë–µ–∑ –ª–æ–∫–∞—Ü–∏–∏').trim(), perHour, ts: serverTimestamp()
          });
          showToast('–ó–∞–ø–∏—Å—å –æ —Ñ–∞—Ä–º–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
          $('adena').value = ''; $('minutes').value = ''; $('location').value = '';
          calculate();
        } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ", e); }
      };
      
      const deleteEntry = async (id) => {
        if (!currentProfile) return;
        try { await deleteDoc(doc(db, 'profiles', currentProfile, 'logs', id)); } catch(e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ", e); }
      };

      const subscribeHistory = (profileName) => {
        if (historyUnsubscribe) historyUnsubscribe();
        const hist = $('history-list');
        const logsQuery = query(collection(db, 'profiles', profileName, 'logs'), orderBy('ts', 'desc'), limit(100));
        historyUnsubscribe = onSnapshot(logsQuery, snap => {
          hist.innerHTML = snap.docs.map(doc => {
            const { location, perHour, ts } = doc.data();
            const date = ts ? ts.toDate().toLocaleString('ru-RU') : '–Ω–µ–¥–∞–≤–Ω–æ';
            const textToCopy = `–õ–æ–∫–∞—Ü–∏—è: ${location}\n–ê–¥–µ–Ω/—á–∞—Å: ${perHour.toLocaleString('ru-RU')}\n–î–∞—Ç–∞: ${date}`;
            return `<div class="entry">
                      <div class="entry-info">
                        <span>${location} ‚Äî ${formatAdenaShort(perHour)} –∞–¥–µ–Ω/—á</span>
                        <span>${date}</span>
                      </div>
                      <div class="entry-buttons">
                        <button class="entry-btn" onclick="app.copyHistoryEntry(\`${textToCopy}\`)" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"><svg viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg></button>
                        <button class="entry-btn del-btn" onclick="app.deleteEntry('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                      </div>
                    </div>`;
          }).join('') || '<p><em>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</em></p>';
        }, error => {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
          hist.innerHTML = '<p><em>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</em></p>';
        });
      };

      const openStats = async () => {
        if (!currentProfile) return;
        $('statsOverlay').classList.add('active');
        const logsQuery = query(collection(db, 'profiles', currentProfile, 'logs'), limit(100));
        const snap = await getDocs(logsQuery);
        let entries = snap.docs.map(d => d.data());
        entries.sort((a,b) => b.perHour - a.perHour);
        const labels = entries.map(e => e.location);
        const data = entries.map(e => e.perHour);
        const oldChart = Chart.getChart('statsChart');
        if (oldChart) { oldChart.destroy(); }
        const ctx = $('statsChart').getContext('2d');
        new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '–ê–¥–µ–Ω/—á', data }] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
      };

      const closeStats = () => { $('statsOverlay').classList.remove('active'); };

      const toggleTheme = () => {
        const isDark = document.body.classList.toggle('dark');
        $('toggle-theme').innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      };

      const openProfileManager = async () => {
        $('profileOverlay').classList.add('active');
        const profileListDiv = $('profile-list');
        profileListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        try {
          const snap = await getDocs(collection(db, 'profiles'));
          profileListDiv.innerHTML = snap.docs.map(doc => `<div class="profile-entry"><button class="btn-primary profile-name-btn" onclick="app.selectProfile('${doc.id}')">${doc.id}</button><button class="profile-delete-btn" onclick="app.deleteProfile('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">‚úï</button></div>`).join('') || '–ü—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.';
        } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:", e); }
      };

      const closeProfileManager = () => { $('profileOverlay').classList.remove('active'); };

      const selectProfile = (profileName) => {
        currentProfile = profileName;
        localStorage.setItem('adenafarm_currentProfile', profileName);
        updateUiForProfile();
        closeProfileManager();
      };

      const createNewProfile = async () => {
        const newNameInput = $('new-profile-name');
        const newName = newNameInput.value.trim();
        if (!newName) { showToast('–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
        await setDoc(doc(db, 'profiles', newName), {});
        newNameInput.value = '';
        selectProfile(newName);
      };

      const deleteProfile = async (profileName) => {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${profileName}"?`)) { return; }
        try {
          const logsQuery = query(collection(db, 'profiles', profileName, 'logs'));
          const logsSnapshot = await getDocs(logsQuery);
          await Promise.all(logsSnapshot.docs.map(logDoc => deleteDoc(logDoc.ref)));
          await deleteDoc(doc(db, 'profiles', profileName));
          if (currentProfile === profileName) {
            currentProfile = null;
            localStorage.removeItem('adenafarm_currentProfile');
            updateUiForProfile();
          }
          await openProfileManager();
        } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ", e); }
      };

      const updateUiForProfile = () => {
        const formElements = ['location', 'adena', 'minutes', 'save-btn', 'stats-btn'];
        if (currentProfile) {
          $('profile-status').textContent = `–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å: ${currentProfile}`;
          formElements.forEach(id => $(id).disabled = false);
          subscribeHistory(currentProfile);
        } else {
          $('profile-status').textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.';
          $('history-list').innerHTML = '<p><em>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</em></p>';
          if (historyUnsubscribe) historyUnsubscribe();
          formElements.forEach(id => $(id).disabled = true);
        }
      };

      const init = () => {
        if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark');
        }
        $('toggle-theme').innerHTML = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        $('adena').addEventListener('input', calculate);
        $('minutes').addEventListener('input', calculate);
        $('minutes').addEventListener('keyup', e => { if (e.key === 'Enter') saveResult(); });
        const savedProfile = localStorage.getItem('adenafarm_currentProfile');
        if (savedProfile) {
          currentProfile = savedProfile;
        }
        updateUiForProfile();
      };

      return {
        init, saveResult, openStats, closeStats, deleteEntry, toggleTheme,
        openProfileManager, closeProfileManager, selectProfile, createNewProfile, deleteProfile,
        copyResult, copyHistoryEntry
      };
    };

    window.app = appModule();
    document.addEventListener('DOMContentLoaded', window.app.init);
  </script>
</body>
</html>
