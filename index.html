<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–∞—Ä–º–∞ –∞–¥–µ–Ω</title>
  <style>
    :root {
      --bg-light: #f7f9fc; --bg-dark: #1c1c1c; --panel-light: #ffffff; --panel-dark: #262626;
      --text-light: #333333; --text-dark: #e1e1e1; --accent: #3a8dde; --accent-hover: #3274c8;
      --error: #e74c3c; --radius: 8px; --spacing: 16px; --transition: 0.3s;
      --font-base: 16px; --line-h: 1.6; --toggle-size: 46px;
      --text-secondary-light: #aaa; --text-secondary-dark: #777;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: var(--font-base); line-height: var(--line-h); color: var(--text-light);
      background: var(--bg-light); transition: background var(--transition), color var(--transition);
      display: flex; flex-direction: column; align-items: center;
    }
    body.dark { background: var(--bg-dark); color: var(--text-dark); }
    .header-controls {
        position: fixed; top: var(--spacing); left: 50%; transform: translateX(-50%);
        display: flex; gap: var(--spacing); align-items: center; z-index: 1000;
    }
    .control-button {
      width: var(--toggle-size); height: var(--toggle-size); border-radius: 50%; padding: 0;
      background: var(--panel-light); color: var(--accent); border: 2px solid var(--accent);
      display: flex; justify-content: center; align-items: center; cursor: pointer;
      transition: background var(--transition), color var(--transition), border-color var(--transition);
      font-size: 1.2rem;
    }
    .control-button svg { width: 50%; height: 50%; fill: var(--accent); transition: fill var(--transition); }
    body.dark .control-button {
      background: var(--panel-dark); color: var(--accent-hover); border-color: var(--accent-hover);
    }
    body.dark .control-button svg { fill: var(--accent-hover); }
    .container {
      display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing); max-width: 960px;
      width: 100%; margin: 120px auto 0; padding: 0 var(--spacing);
    }
    .panel, .history {
      background: var(--panel-light); padding: var(--spacing); border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: background var(--transition);
    }
    body.dark .panel, body.dark .history { background: var(--panel-dark); }
    h1, h2 { margin-top: 0; } h1 { font-size: 1.5rem; margin-bottom: var(--spacing); }
    .field { margin-bottom: var(--spacing); }
    label { display: block; margin-bottom: 4px; font-weight: 500; }
    input {
      width: 100%; padding: 8px 12px; font-size: 1rem; border: 1px solid #ccc;
      border-radius: var(--radius); transition: border var(--transition), box-shadow var(--transition);
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(58,141,222,0.3); outline: none; }
    input:disabled, button:disabled { opacity: 0.6; cursor: not-allowed; }
    .buttons { display: flex; gap: var(--spacing); flex-wrap: wrap; margin-bottom: var(--spacing); }
    button {
      flex: 1; padding: 10px; font-size: 1rem; border: none; border-radius: var(--radius);
      cursor: pointer; transition: background var(--transition), opacity var(--transition);
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    #result { margin-top: var(--spacing); font-size: 1.25rem; font-weight: 600; min-height: 1.5em; text-align: center; }
    .history { max-height: 70vh; overflow-y: scroll; }
    .entry { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing) 8px; margin-bottom: var(--spacing); background: rgba(0,0,0,0.03); border-radius: var(--radius); transition: background var(--transition); }
    body.dark .entry { background: rgba(255,255,255,0.05); }
    .entry-info { display: flex; flex-direction: column; }
    .entry-info span:first-child { font-weight: 600; }
    .entry-info span:last-child { font-size: 0.875rem; color: #666; transition: color var(--transition); }
    body.dark .entry-info span:last-child { color: #aaa; }
    .del-btn { background: none; border: none; font-size: 1rem; color: var(--error); cursor: pointer; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .overlay.active { display: flex; }
    .modal {
      background: var(--panel-light); padding: var(--spacing); border-radius: var(--radius); max-width: 600px;
      width: 90%; box-shadow: 0 2px 12px rgba(0,0,0,0.2); position: relative;
    }
    body.dark .modal { background: var(--panel-dark); }
    .modal-close {
      position: absolute; top: 8px; right: 8px; background: none;
      border: none; font-size: 1.25rem; color: var(--error); cursor: pointer;
    }
    #profile-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: var(--spacing); max-height: 200px; overflow-y: auto; }
    
    /* –ò–ó–ú–ï–ù–ï–ù–û: –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
    .profile-entry {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* –ù–û–í–´–ô –°–¢–ò–õ–¨: –î–µ–ª–∞–µ–º —Å–∞–º—É —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∞—Å—å */
    .profile-name-btn {
      flex-grow: 1;
      text-align: center;
      padding: 5px 10px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
      font-size: 0.9rem; /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç */
      line-height: 1.4;  /* –£–ø—Ä–∞–≤–ª—è–µ–º –≤—ã—Å–æ—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ */
    }
    /* –ù–û–í–´–ô –°–¢–ò–õ–¨: –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∏–ª—å .modal-close */
    .profile-delete-btn {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: var(--radius);
      color: var(--text-secondary-light);
      font-size: 1.25rem; /* –¢–∞–∫–æ–π –∂–µ —Ä–∞–∑–º–µ—Ä, –∫–∞–∫ —É –∫—Ä–µ—Å—Ç–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ */
      font-weight: normal;
      cursor: pointer;
      transition: color 0.2s, background-color 0.2s;
    }
    body.dark .profile-delete-btn {
      color: var(--text-secondary-dark);
    }
    .profile-delete-btn:hover {
      color: var(--error);
      background-color: rgba(231, 76, 60, 0.1);
    }
    
    #profile-status { font-size: 0.9rem; text-align: center; font-weight: 600; }
    @media (max-width: 800px) { .container { display: block; margin-top: 140px; } .history { margin-top: var(--spacing); } }
  </style>
</head>
<body>
  <div class="header-controls">
      <button id="profile-btn" class="control-button" onclick="openProfileManager()" title="–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
      </button>
      <button id="toggle-theme" class="control-button" onclick="toggleTheme()" title="–¢–µ–º–∞">üåô</button>
  </div>
  <div class="container">
    <div class="panel">
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–∞—Ä–º–∞ –∞–¥–µ–Ω</h1>
      <div id="profile-status">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.</div>
      <div class="field">
        <label for="location">–õ–æ–∫–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="location" type="text" placeholder="–õ–æ–∫–∞—Ü–∏—è" disabled/>
      </div>
      <div class="field">
        <label for="adena">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–µ–Ω</label>
        <input id="adena" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥–µ–Ω" disabled/>
      </div>
      <div class="field">
        <label for="minutes">–í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö</label>
        <input id="minutes" type="number" placeholder="–í—Ä–µ–º—è (–º–∏–Ω)" disabled/>
      </div>
      <div class="buttons">
        <button id="save-btn" class="btn-primary" onclick="saveResult()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="stats-btn" class="btn-primary" onclick="openStats()" disabled>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </div>
      <div id="result" aria-live="polite"></div>
    </div>
    <div class="history">
      <h2>–ò—Å—Ç–æ—Ä–∏—è (–º–∞–∫—Å. 100)</h2>
      <div id="history-list"><p><em>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</em></p></div>
    </div>
  </div>
  <div class="overlay" id="statsOverlay">
    <div class="modal"> <button class="modal-close" onclick="closeStats()">‚úï</button> <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞—Ä–º–∞</h3> <canvas id="statsChart"></canvas> </div>
  </div>
  <div class="overlay" id="profileOverlay">
    <div class="modal">
      <button class="modal-close" onclick="closeProfileManager()">‚úï</button>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h3>
      <div id="profile-list-container"> <p>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏:</p> <div id="profile-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div> </div>
      <hr>
      <p>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π:</p>
      <div class="field"> <input id="new-profile-name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è"/> </div>
      <button class="btn-primary" onclick="createNewProfile()">–°–æ–∑–¥–∞—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot, getDocs,
      deleteDoc, doc, setDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyDb3e-6m-ryG4rhK7-w8vptqj4SMUS2Hhw',
      authDomain: 'adenafarm-3260d.firebaseapp.com',
      projectId: 'adenafarm-3260d',
      storageBucket: 'adenafarm-3260d.appspot.com',
      messagingSenderId: '455723070548',
      appId: '1:455723070548:web:03eb62738536d4a0ada9c1'
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const $ = id => document.getElementById(id);

    let currentProfile = null;
    let historyUnsubscribe = null;

    const calculate = () => {
      const a = parseFloat($('adena').value), m = parseFloat($('minutes').value);
      if (!a || !m) { $('result').textContent = ''; return null; }
      const perHour = (a / m) * 60;
      $('result').textContent = `–ó–∞ —á–∞—Å: ${perHour.toLocaleString('ru-RU')} –∞–¥–µ–Ω`;
      return Math.round(perHour);
    };
    const saveResult = async () => {
      if (!currentProfile) return;
      const perHour = calculate();
      if (!perHour) { $('result').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.'; return; }
      try {
        const logsCollection = collection(db, 'profiles', currentProfile, 'logs');
        await addDoc(logsCollection, { location: ($('location').value||'–ë–µ–∑ –ª–æ–∫–∞—Ü–∏–∏').trim(), perHour, ts: serverTimestamp() });
        $('result').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
        $('adena').value = ''; $('minutes').value = ''; $('location').value = '';
      } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ", e); $('result').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.'; }
    };
    const deleteEntry = async (id) => {
        if (!currentProfile) return;
        try { await deleteDoc(doc(db, 'profiles', currentProfile, 'logs', id)); } catch(e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ", e); }
    };
    const subscribeHistory = (profileName) => {
        if (historyUnsubscribe) historyUnsubscribe();
        const hist = $('history-list');
        const logsQuery = query(collection(db, 'profiles', profileName, 'logs'), orderBy('ts','desc'), limit(100));
        historyUnsubscribe = onSnapshot(logsQuery, snap => {
            if (snap.empty) { hist.innerHTML = '<p><em>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</em></p>'; return; }
            hist.innerHTML = snap.docs.map(d => {
              const {location, perHour, ts} = d.data();
              const date = ts ? ts.toDate().toLocaleString('ru-RU') : '–Ω–µ–¥–∞–≤–Ω–æ';
              return `<div class="entry"><div class="entry-info"><span>${location} ‚Äî ${perHour.toLocaleString('ru-RU')} –∞–¥–µ–Ω/—á</span><span>${date}</span></div><button class="del-btn" onclick="deleteEntry('${d.id}')">‚úï</button></div>`;
            }).join('');
        }, error => { console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error); hist.innerHTML = '<p><em>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</em></p>'; });
    };
    const openStats = async () => {
      if (!currentProfile) return;
      $('statsOverlay').classList.add('active');
      const logsQuery = query(collection(db, 'profiles', currentProfile, 'logs'), limit(100));
      const snap = await getDocs(logsQuery);
      let entries = snap.docs.map(d=>d.data());
      entries.sort((a,b)=>b.perHour - a.perHour);
      const labels = entries.map(e=>e.location);
      const data = entries.map(e=>e.perHour);
      const diffs = data.map((v,i)=>i?((v-data[i-1])/data[i-1]*100).toFixed(1):0);
      const oldChart = Chart.getChart('statsChart'); if (oldChart) { oldChart.destroy(); }
      const ctx = $('statsChart').getContext('2d');
      new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'–ê–¥–µ–Ω/—á',data}]},options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{tooltip:{callbacks:{label:ctx=>`${ctx.dataset.data[ctx.dataIndex].toLocaleString('ru-RU')} –∞–¥–µ–Ω/—á (${diffs[ctx.dataIndex]>=0?'+':''}${diffs[ctx.dataIndex]}%)`}}}}});
    };
    const closeStats = () => { $('statsOverlay').classList.remove('active'); };
    const toggleTheme = () => {
      const isDark = document.body.classList.toggle('dark');
      $('toggle-theme').innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    const openProfileManager = async () => {
        $('profileOverlay').classList.add('active');
        const profileListDiv = $('profile-list');
        profileListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        try {
            const profilesCollection = collection(db, 'profiles');
            const snap = await getDocs(profilesCollection);
            if (snap.empty) {
                profileListDiv.innerHTML = '–ü—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.';
                return;
            }
            // –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å .profile-name-btn –∫ –∫–Ω–æ–ø–∫–µ
            profileListDiv.innerHTML = snap.docs.map(doc => `
              <div class="profile-entry">
                <button class="btn-primary profile-name-btn" onclick="selectProfile('${doc.id}')">${doc.id}</button>
                <button class="profile-delete-btn" onclick="deleteProfile('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">‚úï</button>
              </div>
            `).join('');
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:", e);
            profileListDiv.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏.';
        }
    };
    const closeProfileManager = () => { $('profileOverlay').classList.remove('active'); };
    const selectProfile = (profileName) => {
        currentProfile = profileName;
        localStorage.setItem('adenafarm_currentProfile', profileName);
        updateUiForProfile();
        closeProfileManager();
    };
    const createNewProfile = async () => {
        const newNameInput = $('new-profile-name');
        const newName = newNameInput.value.trim();
        if (!newName) { alert('–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
        await setDoc(doc(db, 'profiles', newName), {});
        newNameInput.value = '';
        selectProfile(newName);
    };
    const deleteProfile = async (profileName) => {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${profileName}"? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å—Ç–µ—Ä—Ç—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.`)) {
        return;
      }
      try {
        const logsQuery = query(collection(db, 'profiles', profileName, 'logs'));
        const logsSnapshot = await getDocs(logsQuery);
        const deletePromises = logsSnapshot.docs.map(logDoc => deleteDoc(logDoc.ref));
        await Promise.all(deletePromises);
        await deleteDoc(doc(db, 'profiles', profileName));
        
        if (currentProfile === profileName) {
          currentProfile = null;
          localStorage.removeItem('adenafarm_currentProfile');
          updateUiForProfile();
        }
        await openProfileManager();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.");
      }
    };
    const updateUiForProfile = () => {
        const formElements = ['location', 'adena', 'minutes', 'save-btn', 'stats-btn'];
        if (currentProfile) {
            $('profile-status').textContent = `–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å: ${currentProfile}`;
            formElements.forEach(id => $(id).disabled = false);
            subscribeHistory(currentProfile);
        } else {
            $('profile-status').textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å.';
            $('history-list').innerHTML = '<p><em>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</em></p>';
            if (historyUnsubscribe) historyUnsubscribe();
            formElements.forEach(id => $(id).disabled = true);
        }
    };

    Object.assign(window, {
      saveResult, openStats, closeStats, deleteEntry, toggleTheme,
      openProfileManager, closeProfileManager, selectProfile, createNewProfile, deleteProfile
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark');
      }
      $('toggle-theme').innerHTML = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
      
      $('adena').addEventListener('input', calculate);
      $('minutes').addEventListener('input', calculate);
      $('minutes').addEventListener('keyup', e => { if (e.key === 'Enter') saveResult(); });

      const savedProfile = localStorage.getItem('adenafarm_currentProfile');
      if (savedProfile) {
        currentProfile = savedProfile;
      }
      updateUiForProfile();
    });
  </script>
</body>
</html>